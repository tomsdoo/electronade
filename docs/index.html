<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>electronade</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="electronade is an npm package that provides the extension feature for electron.">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/destyle.css/destyle.min.css" />
  <link rel="stylesheet" href="/css/root.css" />
  <link rel="stylesheet" href="/css/header.css" />
  <link rel="stylesheet" href="/css/main.css" />
  <link rel="stylesheet" href="/css/footer.css" />
  <link rel="stylesheet" href="/css/style.css" />
  <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@100;300&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons%7CMaterial+Icons+Outlined" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/styles/nord.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.4.0/highlight.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js" async defer></script>
  <script src="https://unpkg.com/vue@3"></script>
  <script>
    const markdownPaths = [
      "/md/test1.md",
      "/md/test2.md"
    ];
    const state = Vue.reactive({
      pageContents: [],
      currentPage: undefined,
    });

    async function fetchPageContent(path){
      return fetch(path)
        .then(async response => ({
          rawPath: path,
          hashPath: path
            .replace(/index\.md$/, "")
            .replace(/\.md$/, ""),
          url: response.url,
          text: await response.text()
        }))
        .then(content => ({
          ...content,
          title: content.text.split("\n")[0].replace(/^# /, ""),
          html: marked.parse(content.text)
        }));
    }
    function reflectHash(){
      reflectPage(
        state.pageContents.find(
          ({ hashPath }) => hashPath === location.hash.substring(1)
        ) ||
        state.pageContents.length > 0 && state.pageContents[0]
      );
    }
    function waitMs(ms){
      return new Promise((resolve) => setTimeout(resolve, ms));
    }
    function reflectPage(page){
      console.log(page)
      state.currentPage = undefined;
      waitMs(1).then(async () => {
        state.currentPage = page;
        return await waitMs(1);
      }).then(() => {
        hljs.highlightAll();
      });
    }
    window.addEventListener("load", async () => {
      state.pageContents = await Promise.all(
        markdownPaths.map(
          async (markdownPath) => await fetchPageContent(markdownPath)
        )
      );
      // TODO: remove below line, index items are increased temporarily
      state.pageContents = [...Array(50).keys()].map(() => [...state.pageContents]).flat();

      console.log(state.pageContents)

      const app = Vue.createApp({
        setup: () => ({
          state
        })
      });
      app.mount("#app");

      window.addEventListener("hashchange", reflectHash);
      if(!Boolean(location.hash)){
        location.hash = state.pageContents[0].hashPath;
      }
      reflectHash();
    });
  </script>
</head>
<body>
  <header id="header">
    electronade
  </header>
  <main id="app" v-cloak>
    <ul class="index-list">
      <li
        v-for="(page, index) in state.pageContents"
        :key="index"
        class="item"
      >
        <a
          :href="'#'+page.hashPath"
          class="link"
        >
          <span class="material-icons-outlined icon">article</span>
          <span class="text">{{ page.title }}</span>
        </a>
      </li>
    </ul>
    <section class="content scroll-hidden">
      <transition name="fade">
        <article
          v-if="state.currentPage"
          v-html="state.currentPage.html"
          class="article"
        />
      </transition>
    </section>
  </main>
  <footer id="footer">
    <a
      href="https://www.npmjs.com/package/electron"
      class="footer-link"
      target="_blank"
    >
      <span class="text">npm electron</span>
      <span class="material-icons icon">open_in_new</span>
    </a>
  </footer>
</body>
</html>
