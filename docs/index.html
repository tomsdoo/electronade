<!DOCTYPE html>
<html>
<head>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://unpkg.com/vue@3"></script>
  <script>
    const markdownPaths = [
      "/md/test1.md",
      "/md/test2.md"
    ];
    const state = Vue.reactive({
      pageContents: [],
      currentPage: undefined,
    });

    async function fetchPageContent(path){
      return fetch(path)
        .then(async response => ({
          rawPath: path,
          hashPath: path
            .replace(/index\.md$/, "")
            .replace(/\.md$/, ""),
          url: response.url,
          text: await response.text()
        }))
        .then(content => ({
          ...content,
          title: content.text.split("\n")[0].replace(/^# /, ""),
          html: marked.parse(content.text)
        }));
    }
    function reflectHash(){
      reflectPage(
        state.pageContents.find(
          ({ hashPath }) => hashPath === location.hash.substring(1)
        ) ||
        state.pageContents.length > 0 && state.pageContents[0]
      );
    }
    function waitMs(ms){
      return new Promise((resolve) => setTimeout(resolve, ms));
    }
    function reflectPage(page){
      console.log(page)
      state.currentPage = undefined;
      waitMs(1).then(() => {
        state.currentPage = page;
      });
    }
    window.addEventListener("load", async () => {
      state.pageContents = await Promise.all(
        markdownPaths.map(
          async (markdownPath) => await fetchPageContent(markdownPath)
        )
      );

      console.log(state.pageContents)

      const app = Vue.createApp({
        setup: () => ({
          message: "hello",
          state
        })
      });
      app.mount("#app");

      window.addEventListener("hashchange", reflectHash);
      if(!Boolean(location.hash)){
        location.hash = state.pageContents[0].hashPath;
      }
      reflectHash();
    });
  </script>
  <style>
    [v-cloak] {
      position: relative;
    }
    [v-cloak]::before {
      position: absolute;
      z-index: 1;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>
<body>
  <main id="app" v-cloak>
    <ul>
      <li v-for="page in state.pageContents">
        <a :href="'#'+page.hashPath">
          {{ page.title }}
        </a>
      </li>
    </ul>
    {{ message }}
    <article v-if="state.currentPage" v-html="state.currentPage.html" />
  </main>
</body>
</html>
